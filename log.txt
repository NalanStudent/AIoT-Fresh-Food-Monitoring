Project Change Log

Tuesday, 9 December 2025

Database Consolidation & Schema Update
    `aiot_fresh/init_db.py`: Added `users` table definition to the main database schema.
    `aiot_fresh/auth.py`: Modified `get_db()` function to connect to the unified `aiot.db` at `/var/lib/aiot_fresh/aiot.db`, replacing the separate `aiot_portal.db`.
    `aiot_fresh/admin_create_user.py`: Deleted this file as its functionality is now integrated into the main database and it is considered obsolete.

GPS Data Handling Bug Fix
    `aiot_fresh/mqtt_listener.py`: Corrected `insert_telemetry` function to extract and store individual `lat`, `lon`, `fix`, and `satellites` values from the MQTT payload into their respective database columns, instead of attempting to store a JSON object.
    `aiot_fresh/app.py`: Modified `get_devices()` and `get_device_detail()` functions to retrieve individual `lat`, `lon`, `fix`, and `satellites` columns from the database and reassemble them into a `gps` JSON object for API responses.

MQTT Listener Logic Enhancement
    `aiot_fresh/mqtt_listener.py`:
        Added helper functions: `get_merged_thresholds`, `evaluate_telemetry`, `create_alert`, and `add_to_outbox`.
        Integrated these functions into the `on_message` handler to enable real-time threshold evaluation, alert generation, and queuing of telemetry/alerts for cloud synchronization.

Flask API Endpoint Enhancement
    `aiot_fresh/app.py`:
        Enhanced the `update_thresholds` API endpoint to:
            Update the local container database.
            Construct a full config payload including `last_modified` and `source='pi'`.
            Publish this config to the retained MQTT topic `containers/<device_id>/config` using `paho.mqtt.publish`.
            Add this config payload to the `outbox` table for Firebase synchronization.
        Added `DB_PATH`, `MQTT_HOST` constants, and `add_to_outbox` helper function.

Web Portal UI (Placeholder Creation)
    `aiot_fresh/templates/`: Created this new directory to house HTML templates.
    `aiot_fresh/templates/login.html`: Created a basic HTML login page placeholder.
    `aiot_fresh/templates/dashboard.html`: Created a basic HTML dashboard page placeholder with JavaScript to fetch device data from the `/api/devices` endpoint.

Documentation and Firebase Rules
    `firestore.rules`: Created Firebase security rules to enforce read-only access for mobile clients and prevent unauthorized writes, adhering to the project specification.
    `README.md`: Created a comprehensive README file detailing project setup, installation of dependencies, database initialization, user creation, running services, and Firebase configuration steps. Also outlined the remaining high-level tasks for project completion.


Wednesday, 10 December 2025 (Early Morning)


Development & Debugging Cycle
    `aiot_fresh/create_user.py`: Created a new script to clear the users table and create a single new user for development and testing purposes.
    `aiot_fresh/auth.py`: Fixed a `TypeError` in `verify_login` by encoding the stored password hash to bytes before passing it to `bcrypt.checkpw`.
    Project-wide Database Path Fix:
        Identified a critical bug where the web portal could not see devices due to database permission errors.
        Updated `init_db.py`, `app.py`, `mqtt_listener.py`, `auth.py`, and `create_user.py` to use a local `aiot.db` file within the project directory, instead of a hardcoded system path (`/var/lib/aiot_fresh/aiot.db`). This resolves permission issues and makes the project self-contained for development.

Wednesday, 10 December 2025 (Afternoon/Evening Session)

Project Analysis and Planning
- Analyzed the entire project state against the `gemini.md` specification.
- Generated a detailed, step-by-step completion plan and stored it in `Gemini_NOTE.txt` for future reference.

Portal UI and Backend Finalization
- Fully implemented the "Finalize the Pi Portal" task.
- Created a modular frontend structure with new directories (`/static/css`, `/static/js`) and files (`styles.css`, `dashboard.js`).
- Implemented a dynamic, dark-themed dashboard UI that displays device cards, telemetry, and alerts.
- Added new backend API endpoints to `app.py`:
    - `GET /api/devices/<id>/alerts`: To fetch alerts for a specific device.
    - `POST /api/devices/<id>/test-alert`: To trigger a test alert from the portal.
    - `GET /api/sync/status`: To check the number of items pending cloud sync.

Scope Change: Simplified Food Type and Threshold Management
- Based on user request, the system logic was changed to remove the dependency on the `food_types` table for default thresholds.
- `app.py` and `mqtt_listener.py` were modified to use only device-specific `threshold_overrides`.
- `dashboard.html` and `dashboard.js` were updated to allow `selected_food_type` to be edited as a plain text field.
- Documented this significant deviation in `gemini.md` and `Gemini_NOTE.txt`.

New Feature: Clear Alerts
- Implemented a "Clear Alerts" button on the portal for each device.
- Added a new `DELETE /api/devices/<id>/alerts` endpoint to `app.py` to permanently delete alerts from the local database.
- Updated `dashboard.js` to handle the UI and API call for this feature.
- Documented the new feature in `Gemini_NOTE.txt`.

Bug Fix: Portal Device Status ("Offline" Bug)
- Diagnosed and fixed a bug where devices always appeared "Offline" due to client-server clock differences.
- Moved the status-checking logic from the frontend JavaScript to the backend `app.py`, making the server authoritative for device status.
- Simplified the frontend JavaScript to use the server-provided status directly.

Time Display Management and New Feature
- Addressed an issue where alert timestamps were displayed in a confusing "GMT" format.
- Reverted the timestamp display to use `.toLocaleString()` as a temporary measure per user preference for simplicity.
- Added a new feature: a live-updating UTC clock in the dashboard header.
- Documented the temporary timestamp workaround and the new clock feature in `Gemini_NOTE.txt` for future reference.

Systemd Service Configuration
- Provided detailed instructions and generated `systemd` unit files (`mqtt_listener.service`, `portal.service`) to enable the project services to run automatically on Raspberry Pi boot.
- The configuration was tailored to the user's provided username (`n-pi`) and project path (`/var/lib/aiot_freshX`).
- Saved these instructions for future reference in `pi_system.txt`.

Thursday, 11 December 2025

Cloud Sync & Data Model Refinement
    Implemented `cloud_sync.py` to provide robust, offline-first synchronization of telemetry and alerts to Firebase Firestore.
    Refined Firestore data model from `telemetry/{containerId}/readings/{readingId}` to a more intuitive nested structure: `containers/{containerId}/telemetry/{timestamp}` and `containers/{containerId}/alerts/{timestamp}`. This involved updates to `mqtt_listener.py`, `cloud_sync.py`, and `firestore.rules`.
    Decided to use ISO 8601 timestamps as Firestore document IDs for human readability, noting the acknowledged risk of data collisions.

Stateful Alerting
    Implemented stateful alerting logic in `mqtt_listener.py` to prevent alert spam. The system now tracks active alerts in the local database and only triggers new notifications for new conditions, automatically marks alerts as "resolved" when the condition clears.

System Deployment & Documentation
    Created and documented `systemd` service files for `mqtt_listener.py`, `cloud_sync.py`, and the Flask portal (`app.py` via Gunicorn) to ensure automatic startup on Raspberry Pi boot.
    Updated `pi_system.txt` with comprehensive deployment and management instructions for all three services.
    Updated `gemini.md` with a summary of the architectural deviations and feature enhancements implemented.

Friday, 12 December 2025 - Monday, 15 December 2025

Mobile Application Development & AI Integration

-   Project Scope Finalization:
    -   Formally expanded the mobile app's scope beyond a basic skeleton to a full-featured application.
    -   Added Login (deferred), Health Meter, a full AI page, and Settings to the plan.
    -   Established that the AI backend would be a serverless Cloud Function for security and scalability, rather than running on the Pi.
    -   Updated `gemini.md`, `Gemini_NOTE.txt`, and `mobile_design.txt` to reflect this expanded scope.

-   Mobile App Project Initialization:
    -   Created a new React Native project using Expo (`AIoT-Mobile-App`).
    -   Installed and configured all necessary dependencies for navigation, UI (React Native Paper), maps, charts, and Firebase.
    -   Diagnosed and fixed a critical setup issue where the default Expo Router template was overriding the manual `App.js` entry point. Reconfigured `package.json` and project structure to use the classic navigation setup.

-   Core UI & Navigation Implementation:
    -   Implemented the main bottom tab navigator with three screens: Home, AI Assist, and Settings.
    -   Created and implemented a global theming system using React Context (`ThemeContext`) and React Native Paper, supporting both light and dark modes based on the "Professional Navy & Gold" design.

-   Screen Implementation:
    -   `HomeScreen`: Built a functional dashboard that fetches container data in real-time from Firestore and displays it in a list of `ContainerCard` components.
    -   `HealthMeter`: Implemented the client-side logic and UI for the "Health Meter" on each container card.
    -   `DeviceDetailScreen`: Built the drill-down view, including a Stack Navigator for navigation. The screen fetches and displays detailed data for a single container, including an embedded `MapView`, `LineChart` for historical data, and a list of recent alerts.
    -   `SettingsScreen`: Implemented the UI including a functional toggle switch to control the app's theme (light/dark mode).
    -   `AIScreen`: Built the complete chat interface UI, ready for backend integration.

-   Cloud Function (AI Backend) Development:
    -   Created a new `functions` project, initialized with `firebase init`.
    -   Guided the setup of the Gemini API key as a secure secret in Google Cloud Secret Manager.
    -   Wrote the `askGemini` Node.js cloud function to interact with Firestore and the Gemini API.
    -   Diagnosed and resolved multiple deployment errors, including an outdated Node.js runtime (updated from 18 to 20) and a deprecated Gemini model name (updated from `gemini-pro` to `gemini-2.5-flash`).

-   Final Integration:
    -   Successfully deployed the `askGemini` cloud function.
    -   Integrated the mobile app's `AIScreen` with the live cloud function, replacing the mock UI with a fully functional AI assistant.
